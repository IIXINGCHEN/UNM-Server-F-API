# UNM-Server 安全增强文档

本文档详细描述了UNM-Server API服务中实施的安全增强措施，确保服务在生产环境中安全、稳定运行。

## 安全增强措施

### 1. 敏感信息保护

- **错误响应净化**：移除所有API响应中的敏感错误信息和堆栈跟踪
- **API密钥掩码处理**：实现API密钥脱敏，避免在日志中泄露完整密钥
- **健康状态接口安全化**：隐藏系统敏感信息，包括网络接口、主机名、客户端IP和用户代理
- **服务配置信息脱敏**：对Redis URL和音乐API URL等配置信息进行掩码处理

### 2. 认证与授权

- **API密钥验证增强**：实现缓存机制提高性能，支持多密钥管理
- **IP白名单验证**：支持基于IP地址的访问控制，包括通配符匹配
- **请求频率限制**：基于IP和API密钥的限流机制，防止滥用
- **资源访问控制**：限制非授权访问各种API端点

### 3. 输入验证与净化

- **参数验证**：对所有API参数进行类型和格式验证
- **输入长度限制**：限制ID和其他输入参数的最大长度
- **特殊字符过滤**：防止潜在的注入攻击
- **URL净化**：对输入和输出的URL进行验证和净化

### 4. 安全响应头

- **内容安全策略(CSP)**：限制资源加载来源
- **HSTS安全头**：强制使用HTTPS
- **XSS防护**：启用浏览器内置XSS过滤
- **Frame保护**：防止网站被嵌入iframe
- **MIME类型保护**：防止MIME类型嗅探攻击

### 5. 错误处理增强

- **生产环境错误掩码**：在生产环境中使用通用错误消息
- **错误分类**：区分客户端错误和服务端错误
- **未捕获异常处理**：特殊处理未捕获的异常和Promise拒绝
- **安全日志记录**：确保错误日志不包含敏感信息
- **优雅降级**：当服务部分功能不可用时实现优雅降级

### 6. 日志安全

- **敏感信息掩码**：对所有日志中的敏感信息进行掩码处理
- **分级日志**：根据不同环境配置不同级别的日志详细程度
- **结构化日志**：使用结构化格式便于分析和监控
- **日志轮转**：实现日志轮转避免信息泄露和磁盘空间占用

## 安全配置指南

### 生产环境推荐配置

```
# 安全基础配置
NODE_ENV=production
ENABLE_API_AUTH=true
API_KEYS=<your-secure-api-keys>
ENABLE_IP_WHITELIST=true  # 如需IP限制
IP_WHITELIST=<allowed-ips>

# 请求限制配置
ENABLE_RATE_LIMIT=true
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW=60000

# 日志配置
LOG_LEVEL=warn  # 生产环境推荐warn或error级别
ENABLE_LOG_ROTATION=true
LOG_ROTATION_INTERVAL=1d

# CORS配置
ALLOWED_DOMAIN=your-frontend-domain.com
```

### Docker安全配置

1. 使用非root用户运行容器
2. 设置资源限制
3. 使用多阶段构建减小攻击面
4. 定期更新基础镜像

### 部署安全检查清单

- [x] 启用API密钥认证
- [x] 配置HTTPS
- [x] 设置合理的请求频率限制
- [x] 确保错误处理不泄露敏感信息
- [x] 启用适当级别的日志记录
- [x] 配置防火墙规则
- [x] 确保敏感环境变量安全存储
- [x] 设置资源使用监控
- [x] 实施定期更新和安全审计

## 安全最佳实践

1. **定期更新依赖**：使用npm audit定期检查并更新有安全漏洞的依赖
2. **秘钥轮换**：定期更换API密钥
3. **监控异常**：实施异常监控和告警机制
4. **安全备份**：确保数据和配置的安全备份
5. **渗透测试**：定期进行安全测试
6. **文档更新**：保持安全文档的更新和团队的安全意识 